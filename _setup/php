-- $db = new PDO('mysql:host=localhost;dbname=sa_webapp;charset=utf8mb4', 'dramelon', 'dramelon', [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);

CREATE DATABASE sa_app
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_general_ci;

USE sa_app;




-- STAFFS (aka: user) v2
CREATE TABLE staffs (
    StaffID INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    LastLogin DATETIME DEFAULT NULL,
    Username VARCHAR(100) NOT NULL UNIQUE,
    Password VARCHAR(255) NOT NULL,
    FullName VARCHAR(200) DEFAULT NULL,
    Email VARCHAR(255) DEFAULT NULL UNIQUE,
    Phone VARCHAR(50) DEFAULT NULL,
    AvatarPath VARCHAR(255) DEFAULT NULL;
    Role VARCHAR(50) DEFAULT 'staff',
    Status ENUM('active','inactive','suspended') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

-- in case if missing only "AvatarPath" (this added in v2)
ALTER TABLE staffs
    ADD COLUMN AvatarPath VARCHAR(255) NULL AFTER Phone;




-- ANNOUNCEMENT (aka: news/announce) v1
CREATE TABLE Announcement (
    AnnounceID   INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    Topic        VARCHAR(255) NOT NULL,
    Description  TEXT NOT NULL,
    AnnounceDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    Announcer    INT UNSIGNED NULL,
    Archived     TINYINT(1) NOT NULL DEFAULT 0,
    
    INDEX idx_archived_date (Archived, AnnounceDate),
    CONSTRAINT fk_announce_staff
    FOREIGN KEY (Announcer) REFERENCES staffs(StaffID)
    ON DELETE SET NULL ON UPDATE CASCADE
);




-- EVENTS v1
CREATE TABLE events (
    EventID      BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    Name         VARCHAR(200)    NOT NULL,
    StaffID      INT UNSIGNED    NULL,
    CustomerID   INT UNSIGNED    NULL,
    LocationID   INT UNSIGNED    NULL,
    ILR_ID       INT UNSIGNED    NULL,
    CreatedAt    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    StartDate    DATETIME        NULL,
    EndDate      DATETIME        NULL,
    Description  TEXT            NULL,
    Status       ENUM('draft','incoming','ongoing','completed','canceled') NOT NULL DEFAULT 'draft',
    Notes        TEXT            NULL,
    Archived     TINYINT(1)      NOT NULL DEFAULT 0,

    PRIMARY KEY (EventID),
    INDEX idx_status_start (Status, StartDate),
    INDEX idx_staff (StaffID),
    INDEX idx_customer (CustomerID),
    INDEX idx_location (LocationID),
    UNIQUE KEY uq_ilr (ILR_ID),

    CONSTRAINT fk_event_staff
        FOREIGN KEY (StaffID)    REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_customer
        FOREIGN KEY (CustomerID) REFERENCES customers(CustomerID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_location
        FOREIGN KEY (LocationID) REFERENCES locations(LocationID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_ilr
        FOREIGN KEY (ILR_ID)     REFERENCES item_list_requests(ILR_ID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




-- CUSTOMERS v1
CREATE TABLE customers (
    CustomerID     INT UNSIGNED NOT NULL AUTO_INCREMENT,
    Name           VARCHAR(150) NOT NULL,
    OrgName        VARCHAR(150) DEFAULT NULL,
    Phone          VARCHAR(50)  DEFAULT NULL,
    Email          VARCHAR(150) DEFAULT NULL,
    TaxID          VARCHAR(50)  DEFAULT NULL,
    BillingAddress INT UNSIGNED DEFAULT NULL,     -- FK â†’ locations
    Notes          TEXT         DEFAULT NULL,
    Archived       TINYINT(1)   NOT NULL DEFAULT 0,

    PRIMARY KEY (CustomerID),
    INDEX idx_org (OrgName),
    CONSTRAINT fk_customer_location
    FOREIGN KEY (BillingAddress)
    REFERENCES locations(LocationID)
    ON DELETE SET NULL ON UPDATE CASCADE
)




-- LOCATIONS v1
CREATE TABLE locations (
    LocationID   INT UNSIGNED NOT NULL AUTO_INCREMENT,
    Address1     VARCHAR(255) NOT NULL,
    Address2     VARCHAR(255) DEFAULT NULL,
    Name         VARCHAR(150) DEFAULT NULL,
    Notes        TEXT DEFAULT NULL,
    Archived     TINYINT(1) NOT NULL DEFAULT 0,

    PRIMARY KEY (LocationID)
)




-- ITEMS v1
CREATE TABLE items (
    ItemID        INT UNSIGNED NOT NULL AUTO_INCREMENT,
    ItemType      VARCHAR(100) NOT NULL,
    SerialNumber  VARCHAR(100) DEFAULT NULL,
    Name          VARCHAR(150) NOT NULL,
    Category      VARCHAR(100) DEFAULT NULL,
    CanBeExpensed TINYINT(1) NOT NULL DEFAULT 0,
    Price         DECIMAL(12,2) DEFAULT 0.00,
    Status        ENUM('available','in_use','maintenance','lost','disposed', 'reserve') NOT NULL DEFAULT 'available',
    Active        TINYINT(1) NOT NULL DEFAULT 1,
    Notes         TEXT DEFAULT NULL,

    PRIMARY KEY (ItemID),
    INDEX idx_category (Category)
)




-- ITEMLISTREQUEST v1
CREATE TABLE item_list_requests (
    ILR_ID      INT UNSIGNED NOT NULL AUTO_INCREMENT,
    EventID     BIGINT UNSIGNED DEFAULT NULL,   -- linked to events later
    CreatedAt   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    Notes       TEXT DEFAULT NULL,
    Status      ENUM('draft','waiting','processing','completed','canceled') NOT NULL DEFAULT 'draft',

    PRIMARY KEY (ILR_ID),
    INDEX idx_status (Status)
)

CREATE TABLE item_list_request_lines (
    LineID        BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    ILR_ID        INT UNSIGNED NOT NULL,
    ItemID        INT UNSIGNED DEFAULT NULL,
    ItemType      VARCHAR(100) DEFAULT NULL,
    QtyRequested  INT UNSIGNED NOT NULL DEFAULT 1,
    Notes         TEXT DEFAULT NULL,
    Status        ENUM('waiting','approved','rejected') NOT NULL DEFAULT 'waiting',

    PRIMARY KEY (LineID),
    INDEX idx_ilr (ILR_ID),
    CONSTRAINT fk_line_ilr
        FOREIGN KEY (ILR_ID) REFERENCES item_list_requests(ILR_ID)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_line_item
        FOREIGN KEY (ItemID) REFERENCES items(ItemID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




