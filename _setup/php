-- $db = new PDO('mysql:host=localhost;dbname=sa_webapp;charset=utf8mb4', 'dramelon', 'dramelon', [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);

CREATE DATABASE sa_app
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;

USE sa_app;




-- STAFFS (aka: user) v2
CREATE TABLE staffs (
    StaffID INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    LastLogin DATETIME DEFAULT NULL,
    Username VARCHAR(100) NOT NULL UNIQUE,
    Password VARCHAR(255) NOT NULL,
    FullName VARCHAR(200) DEFAULT NULL,
    Email VARCHAR(255) DEFAULT NULL UNIQUE,
    Phone VARCHAR(50) DEFAULT NULL,
    AvatarPath VARCHAR(255) DEFAULT NULL;
    Role VARCHAR(50) DEFAULT 'staff',
    Status ENUM('active','inactive','suspended') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

-- in case if missing only "AvatarPath" (this added in v2)
ALTER TABLE staffs
    ADD COLUMN AvatarPath VARCHAR(255) NULL AFTER Phone;




-- ANNOUNCEMENT [requirement: staffs] (aka: news/announce) v1
CREATE TABLE Announcement (
    AnnounceID   INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    Topic        VARCHAR(255) NOT NULL,
    Description  TEXT NOT NULL,
    AnnounceDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    Announcer    INT UNSIGNED NULL,
    Archived     TINYINT(1) NOT NULL DEFAULT 0,
    
    INDEX idx_archived_date (Archived, AnnounceDate),
    CONSTRAINT fk_announce_staff
    FOREIGN KEY (Announcer) REFERENCES staffs(StaffID)
    ON DELETE SET NULL ON UPDATE CASCADE
);




-- LOCATIONS v1
CREATE TABLE locations (
    LocationID    INT UNSIGNED NOT NULL AUTO_INCREMENT,
    Loc_Name      VARCHAR(150) DEFAULT NULL,
    House_Number  VARCHAR(50)  DEFAULT NULL,
    Village       VARCHAR(150) DEFAULT NULL,
    Building_Name VARCHAR(150) DEFAULT NULL,
    Floor         VARCHAR(50)  DEFAULT NULL,
    Room          VARCHAR(50)  DEFAULT NULL,
    Street        VARCHAR(150) DEFAULT NULL,
    Subdistrict   VARCHAR(150) DEFAULT NULL,
    District      VARCHAR(150) DEFAULT NULL,
    Province      VARCHAR(150) DEFAULT NULL,
    Postal_Code   VARCHAR(20)  DEFAULT NULL,
    Country       VARCHAR(100) DEFAULT NULL,
    Notes         TEXT         DEFAULT NULL,
    PRIMARY KEY (LocationID)
);




-- CUSTOMERS [requirement: locations] v1
CREATE TABLE customers (
    CustomerID    INT UNSIGNED NOT NULL AUTO_INCREMENT,
    LocationID    INT UNSIGNED DEFAULT NULL,     -- billing/contact address
    Customer_Name VARCHAR(150) NOT NULL,
    OrgName       VARCHAR(150) DEFAULT NULL,
    Email         VARCHAR(150) DEFAULT NULL,
    Phone         VARCHAR(50)  DEFAULT NULL,
    TaxID         VARCHAR(50)  DEFAULT NULL,
    Status        ENUM('active','inactive') NOT NULL DEFAULT 'active',
    Notes         TEXT DEFAULT NULL,
    PRIMARY KEY (CustomerID),
    KEY idx_customer_location (LocationID),
    CONSTRAINT fk_customer_location
        FOREIGN KEY (LocationID)
        REFERENCES locations(LocationID)
        ON DELETE SET NULL ON UPDATE CASCADE
);




-- EVENTS [requirement: staffs, customers, locations] v1
CREATE TABLE events (
    EventID      BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    Event_Name   VARCHAR(200) NOT NULL,
    StaffID      INT UNSIGNED    DEFAULT NULL,   -- FK → staffs
    CustomerID   INT UNSIGNED    DEFAULT NULL,   -- FK → customers
    LocationID   INT UNSIGNED    DEFAULT NULL,   -- FK → locations

    CreatedAt    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    StartDate    DATETIME DEFAULT NULL,
    EndDate      DATETIME DEFAULT NULL,

    Description  TEXT DEFAULT NULL,
    Status       ENUM('draft', 'planning', 'waiting', 'processing', 'billing', 'completed', 'cancelled') NOT NULL DEFAULT 'draft',
    PicturePath  VARCHAR(255) DEFAULT NULL,
    FilePath     VARCHAR(255) DEFAULT NULL,
    Notes        TEXT DEFAULT NULL,

    PRIMARY KEY (EventID),
    KEY idx_status_start (Status, StartDate),
    KEY idx_staff (StaffID),
    KEY idx_customer (CustomerID),
    KEY idx_location (LocationID),

    CONSTRAINT fk_event_staff
        FOREIGN KEY (StaffID) REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_customer
        FOREIGN KEY (CustomerID) REFERENCES customers(CustomerID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_location
        FOREIGN KEY (LocationID) REFERENCES locations(LocationID)
        ON DELETE SET NULL ON UPDATE CASCADE
);