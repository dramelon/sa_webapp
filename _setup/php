-- $db = new PDO('mysql:host=localhost;dbname=sa_webapp;charset=utf8mb4', 'dramelon', 'dramelon', [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);

CREATE DATABASE sa_app
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;

USE sa_app;




-- STAFFS (aka: user) v2
CREATE TABLE staffs (
    StaffID INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    LastLogin DATETIME DEFAULT NULL,
    Username VARCHAR(100) NOT NULL UNIQUE,
    Password VARCHAR(255) NOT NULL,
    FullName VARCHAR(200) DEFAULT NULL,
    Email VARCHAR(255) DEFAULT NULL UNIQUE,
    Phone VARCHAR(50) DEFAULT NULL,
    AvatarPath VARCHAR(255) DEFAULT NULL;
    Role VARCHAR(50) DEFAULT 'staff',
    Status ENUM('active','inactive','suspended') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

-- in case if missing only "AvatarPath" (this added in v2)
ALTER TABLE staffs
    ADD COLUMN AvatarPath VARCHAR(255) NULL AFTER Phone;




-- ANNOUNCEMENT [requirement: staffs] (aka: news/announce) v1
CREATE TABLE Announcement (
    AnnounceID   INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    Topic        VARCHAR(255) NOT NULL,
    Description  TEXT NOT NULL,
    AnnounceDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    Announcer    INT UNSIGNED NULL,
    Archived     TINYINT(1) NOT NULL DEFAULT 0,
    
    INDEX idx_archived_date (Archived, AnnounceDate),
    CONSTRAINT fk_announce_staff
    FOREIGN KEY (Announcer) REFERENCES staffs(StaffID)
    ON DELETE SET NULL ON UPDATE CASCADE
);




-- LOCATIONS v2 [requirement: staffs]
CREATE TABLE locations (
    LocationID      BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    RefLocationID   VARCHAR(30)      DEFAULT NULL,
    LocationName    VARCHAR(200)     NOT NULL,
    Email           VARCHAR(254)     DEFAULT NULL,
    Phone           VARCHAR(32)      DEFAULT NULL,
    Village         VARCHAR(100)     DEFAULT NULL,
    HouseNumber     VARCHAR(30)      DEFAULT NULL,
    BuildingName    VARCHAR(150)     DEFAULT NULL,
    Room            VARCHAR(30)      DEFAULT NULL,
    Floor           VARCHAR(30)      DEFAULT NULL,
    Street          VARCHAR(150)     DEFAULT NULL,
    Subdistrict     VARCHAR(100)     DEFAULT NULL,
    District        VARCHAR(100)     DEFAULT NULL,
    Province        VARCHAR(100)     DEFAULT NULL,
    Country         VARCHAR(100)     DEFAULT NULL,
    PostalCode      VARCHAR(20)      DEFAULT NULL,

    Note            TEXT             DEFAULT NULL,
    Status          ENUM('active','inactive') NOT NULL DEFAULT 'active',

    CreatedAt       DATETIME         NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy       INT UNSIGNED     DEFAULT NULL,
    UpdatedAt       DATETIME         DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy       INT UNSIGNED     DEFAULT NULL,

    PRIMARY KEY (LocationID),
    UNIQUE KEY uq_locations_ref (RefLocationID),
    CONSTRAINT fk_location_createdby FOREIGN KEY (CreatedBy)
        REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_location_updatedby FOREIGN KEY (UpdatedBy)
        REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




-- CUSTOMERS v2 [requirement: locations, staffs]
CREATE TABLE customers (
    CustomerID      BIGINT UNSIGNED  NOT NULL AUTO_INCREMENT,
    RefCustomerID   VARCHAR(30)      DEFAULT NULL,
    LocationID      BIGINT UNSIGNED  DEFAULT NULL,
    CustomerName    VARCHAR(200)     NOT NULL,
    OrgName         VARCHAR(200)     DEFAULT NULL,
    Email           VARCHAR(254)     DEFAULT NULL,
    Phone           VARCHAR(32)      DEFAULT NULL,
    TaxID           VARCHAR(32)      DEFAULT NULL,
    ContactPerson   VARCHAR(200)     DEFAULT NULL,

    Notes           TEXT             DEFAULT NULL,
    Status          ENUM('active','inactive') NOT NULL DEFAULT 'active',

    CreatedAt       DATETIME         NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy       INT UNSIGNED     DEFAULT NULL,
    UpdatedAt       DATETIME         DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy       INT UNSIGNED     DEFAULT NULL,

    PRIMARY KEY (CustomerID),
    UNIQUE KEY uq_customers_ref (RefCustomerID),
    KEY idx_customer_location (LocationID),
    CONSTRAINT fk_customer_location FOREIGN KEY (LocationID)
        REFERENCES locations(LocationID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_customer_createdby FOREIGN KEY (CreatedBy)
        REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_customer_updatedby FOREIGN KEY (UpdatedBy)
        REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




-- EVENTS [requirement: staffs, customers, locations] v3
CREATE TABLE events (
    EventID      BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    RefEventID   VARCHAR(30)      DEFAULT NULL,
    EventName    VARCHAR(200)     NOT NULL,
    StaffID      INT  UNSIGNED    DEFAULT NULL,
    CustomerID   BIGINT UNSIGNED  DEFAULT NULL,
    LocationID   BIGINT UNSIGNED  DEFAULT NULL,
    StartDate    DATETIME         DEFAULT NULL,
    EndDate      DATETIME         DEFAULT NULL,
    
    Description  TEXT             DEFAULT NULL,
    Notes        TEXT             DEFAULT NULL,
    Status       ENUM('draft','planning','waiting','processing','billing','completed','cancelled') NOT NULL DEFAULT 'draft',

    CreatedAt    DATETIME         NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy    INT  UNSIGNED    DEFAULT NULL,
    UpdatedAt    DATETIME         NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy    INT  UNSIGNED    DEFAULT NULL,

    PRIMARY KEY (EventID),
    UNIQUE KEY uq_events_ref (RefEventID),

    KEY idx_status_start (Status, StartDate),
    KEY idx_dates (StartDate, EndDate),
    KEY idx_staff (StaffID),
    KEY idx_customer (CustomerID),
    KEY idx_location (LocationID),
    KEY idx_createdby (CreatedBy),
    KEY idx_updatedby (UpdatedBy),

    CONSTRAINT chk_event_dates CHECK (
        StartDate IS NULL OR EndDate IS NULL OR EndDate >= StartDate
    ),

    CONSTRAINT fk_event_staff
        FOREIGN KEY (StaffID)   REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_customer
        FOREIGN KEY (CustomerID) REFERENCES customers(CustomerID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_location
        FOREIGN KEY (LocationID) REFERENCES locations(LocationID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_createdby
        FOREIGN KEY (CreatedBy) REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_event_updatedby
        FOREIGN KEY (UpdatedBy) REFERENCES staffs(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




-- ITEMCATEGORY [requirement: staffs] v1
CREATE TABLE itemcategory (
    ItemCategoryID BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    Name           VARCHAR(150) NOT NULL,
    CreatedAt       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy       INT UNSIGNED DEFAULT NULL,
    UpdatedAt       DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy       INT UNSIGNED DEFAULT NULL,
    Note           TEXT DEFAULT NULL,
    PRIMARY KEY (ItemCategoryID)
)




-- ITEMS [requirement: staffs, itemcategory] v1
CREATE TABLE items (
    ItemID          BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    RefItemID       VARCHAR(30) DEFAULT NULL,
    ItemName        VARCHAR(200) NOT NULL,
    ItemType        ENUM('อุปกร','วัสดุ','บริการ','') NULL DEFAULT 'อุปกร';
    ItemCategoryID  BIGINT UNSIGNED DEFAULT NULL,
    Brand           VARCHAR(100) DEFAULT NULL,
    Model           VARCHAR(100) DEFAULT NULL,
    UOM             VARCHAR(50) NOT NULL DEFAULT 'unit',
    Rate            DECIMAL(10,2) DEFAULT NULL,
    Period          ENUM('อุปกร','วัสดุ','บริการ','') NOT NULL DEFAULT 'อุปกร';
    CreatedAt       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy       INT UNSIGNED DEFAULT NULL,
    UpdatedAt       DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy       INT UNSIGNED DEFAULT NULL,
    PRIMARY KEY (ItemID),
    KEY idx_item_category (ItemCategoryID),
    CONSTRAINT fk_item_category FOREIGN KEY (ItemCategoryID)
        REFERENCES itemcategory(ItemCategoryID)
        ON DELETE SET NULL ON UPDATE CASCADE
)




-- ITEM_UNIT [requirement: staffs, itemcategory, ITEMS] v1
CREATE TABLE item_unit (
    ItemUnitID       BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    ItemID           BIGINT UNSIGNED NOT NULL,
    WarehouseID      BIGINT UNSIGNED DEFAULT NULL,
    SupplierID       BIGINT UNSIGNED DEFAULT NULL,
    SerialNumber     VARCHAR(150) DEFAULT NULL,
    OwnerShip        ENUM('company','rented') NULL DEFAULT 'company',
    ConditionIn      ENUM('good','damaged') NULL DEFAULT 'good',
    ConditionOut     ENUM('good','damaged') NULL DEFAULT 'good',
    ExpectedReturnAt DATETIME DEFAULT NULL,
    ReturnAt         DATETIME DEFAULT NULL,
    Status           ENUM('useable','in use','pending booking','booked','damaged','reparing','delivering','returned','depreciated') NOT NULL DEFAULT 'useable',
    CreatedAt        DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedBy        INT UNSIGNED DEFAULT NULL,
    UpdatedAt        DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UpdatedBy        INT UNSIGNED DEFAULT NULL,
    PRIMARY KEY (ItemUnitID),
    KEY idx_itemunit_item (ItemID),
    CONSTRAINT fk_itemunit_item FOREIGN KEY (ItemID)
        REFERENCES items(ItemID)
        ON DELETE CASCADE ON UPDATE CASCADE
)